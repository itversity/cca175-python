
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>7. Windowing Functions &#8212; My Jupyter Book</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Spark Metastore" href="08_spark_metastore.html" />
    <link rel="prev" title="6. Joining Data Sets" href="06_joining_data_sets.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">My Jupyter Book</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../cca175_intro.html">
   CCA 175 - Spark and Hadoop Developer - Python
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Apache Spark using Python
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/01_getting_started.html">
   1. Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/02_quick_recap_of_python.html">
   2. Quick Recap of Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/03_data_processing_overview.html">
   3. Data Processing - Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/04_processing_column_data.html">
   4. Processing Column Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/05_basic_transformations.html">
   5. Basic Transformations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/06_joining_data_sets.html">
   6. Joining Data Sets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/07_windowing_functions.html">
   7. Windowing Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-python/08_spark_metastore.html">
   8. Spark Metastore
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Apache Spark using Scala
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01_getting_started.html">
   1. Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_quick_recap_of_scala.html">
   2. Quick Recap of Scala
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_data_processing_overview.html">
   3. Data Processing - Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_processing_column_data.html">
   4. Processing Column Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_basic_transformations.html">
   5. Basic Transformations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_joining_data_sets.html">
   6. Joining Data Sets
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   7. Windowing Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_spark_metastore.html">
   8. Spark Metastore
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Apache Spark using SQL
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/01_getting_started.html">
   1. Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/02_basic_transformations.html">
   2. Basic Transformations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/03_basic_ddl_and_dml.html">
   3. Basic DDL and DML
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/04_dml_and_partitioning.html">
   4. DML and Partitioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/05_predefined_functions.html">
   5. Pre-defined Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../spark-sql/06_windowing_functions.html">
   6. Windowing Functions
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/spark-scala/07_windowing_functions.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/spark-scala/07_windowing_functions.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#starting-spark-context">
   7.1. Starting Spark Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview-of-windowing-functions">
   7.2. Overview of Windowing Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aggregate-functions">
   7.3. Aggregate Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-rowsbetween-and-rangebetween">
   7.4. Using rowsBetween and rangeBetween
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ranking-functions">
   7.5. Ranking Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tasks">
     7.5.1. Tasks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytic-functions">
   7.6. Analytic Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-lead">
     7.6.1. Using LEAD
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-lead-with-7">
     7.6.2. Using LEAD with 7
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="windowing-functions">
<h1><span class="section-number">7. </span>Windowing Functions<a class="headerlink" href="#windowing-functions" title="Permalink to this headline">¶</a></h1>
<p>As part of this module let us get into Windowing Functions.</p>
<div class="section" id="starting-spark-context">
<h2><span class="section-number">7.1. </span>Starting Spark Context<a class="headerlink" href="#starting-spark-context" title="Permalink to this headline">¶</a></h2>
<p>Let us start spark context for this Notebook so that we can execute the code provided.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span>
    <span class="n">builder</span><span class="o">.</span>
    <span class="n">config</span><span class="o">(</span><span class="s">&quot;spark.ui.port&quot;</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">).</span>
    <span class="n">appName</span><span class="o">(</span><span class="s">&quot;Windowing Functions&quot;</span><span class="o">).</span>
    <span class="n">master</span><span class="o">(</span><span class="s">&quot;yarn&quot;</span><span class="o">).</span>
    <span class="n">getOrCreate</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="s">&quot;spark.sql.shuffle.partitions&quot;</span><span class="o">,</span> <span class="s">&quot;2&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="overview-of-windowing-functions">
<h2><span class="section-number">7.2. </span>Overview of Windowing Functions<a class="headerlink" href="#overview-of-windowing-functions" title="Permalink to this headline">¶</a></h2>
<p>Let us get an overview of Windowing Functions.</p>
<ul class="simple">
<li><p>First let us understand relevance of these functions using <code class="docutils literal notranslate"><span class="pre">employees</span></code> data set.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">employeesPath</span> <span class="o">=</span> <span class="s">&quot;/public/hr_db/employees&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span>
    <span class="n">read</span><span class="o">.</span>
    <span class="n">format</span><span class="o">(</span><span class="s">&quot;csv&quot;</span><span class="o">).</span>
    <span class="n">option</span><span class="o">(</span><span class="s">&quot;sep&quot;</span><span class="o">,</span> <span class="s">&quot;\t&quot;</span><span class="o">).</span>
    <span class="n">schema</span><span class="o">(</span><span class="s">&quot;&quot;&quot;employee_id INT, </span>
<span class="s">              first_name STRING, </span>
<span class="s">              last_name STRING, </span>
<span class="s">              email STRING,</span>
<span class="s">              phone_number STRING, </span>
<span class="s">              hire_date STRING, </span>
<span class="s">              job_id STRING, </span>
<span class="s">              salary FLOAT,</span>
<span class="s">              commission_pct STRING,</span>
<span class="s">              manager_id STRING, </span>
<span class="s">              department_id STRING</span>
<span class="s">            &quot;&quot;&quot;</span><span class="o">).</span>
    <span class="n">load</span><span class="o">(</span><span class="n">employeesPath</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">employees</span><span class="o">.</span>
    <span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;employee_id&quot;</span><span class="o">,</span> 
           <span class="n">$</span><span class="s">&quot;department_id&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">),</span> 
           <span class="n">$</span><span class="s">&quot;salary&quot;</span>
          <span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">,</span> <span class="s">&quot;salary&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let us say we want to compare individual salary with department wise salary expense.</p></li>
<li><p>Here is one of the approach which require self join.</p>
<ul>
<li><p>Compute department wise expense usig <code class="docutils literal notranslate"><span class="pre">groupBy</span></code> and <code class="docutils literal notranslate"><span class="pre">agg</span></code>.</p></li>
<li><p>Join with <strong>employees</strong> again on department_id.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">sum</span><span class="o">,</span> <span class="n">col</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">department_expense</span> <span class="o">=</span> <span class="n">employees</span><span class="o">.</span>
    <span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">).</span>
    <span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="s">&quot;salary&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;expense&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">department_expense</span><span class="o">.</span><span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">employees</span><span class="o">.</span>
    <span class="n">select</span><span class="o">(</span><span class="s">&quot;employee_id&quot;</span><span class="o">,</span> <span class="s">&quot;department_id&quot;</span><span class="o">,</span> <span class="s">&quot;salary&quot;</span><span class="o">).</span>
    <span class="n">join</span><span class="o">(</span><span class="n">department_expense</span><span class="o">,</span> <span class="n">employees</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">)</span> <span class="o">===</span> <span class="n">department_expense</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">employees</span><span class="o">(</span><span class="s">&quot;department_id&quot;</span><span class="o">),</span> <span class="n">$</span><span class="s">&quot;salary&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<p><strong>However, using this approach is not very efficient and also overly complicated. Windowing functions actually simplify the logic and also runs efficiently</strong></p>
<p>Now let us get into the details related to Windowing functions.</p>
<ul class="simple">
<li><p>Main package <code class="docutils literal notranslate"><span class="pre">org.apache.spark.sql.expressions</span></code></p></li>
<li><p>It has classes such as <code class="docutils literal notranslate"><span class="pre">Window</span></code> and <code class="docutils literal notranslate"><span class="pre">WindowSpec</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Window</span></code> have APIs such as <code class="docutils literal notranslate"><span class="pre">partitionBy</span></code>, <code class="docutils literal notranslate"><span class="pre">orderBy</span></code> etc</p></li>
<li><p>These APIs (such as <code class="docutils literal notranslate"><span class="pre">partitionBy</span></code>) return <code class="docutils literal notranslate"><span class="pre">WindowSpec</span></code> object. We can pass <code class="docutils literal notranslate"><span class="pre">WindowSpec</span></code> object to over on functions such as <code class="docutils literal notranslate"><span class="pre">rank()</span></code>, <code class="docutils literal notranslate"><span class="pre">dense_rank()</span></code>, <code class="docutils literal notranslate"><span class="pre">sum()</span></code> etc</p></li>
<li><p>Syntax: <code class="docutils literal notranslate"><span class="pre">sum().over(spec)</span></code> where <code class="docutils literal notranslate"><span class="pre">spec</span> <span class="pre">=</span> <span class="pre">Window.partitionBy(&quot;ColumnName&quot;)</span></code></p></li>
</ul>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Functions</p></th>
<th class="text-align:center head"><p>API or Function</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Aggregate Functions</p></td>
<td class="text-align:center"><p><ul><li>sum</li><li>avg</li><li>min</li><li>max</li></ul></p></td>
</tr>
<tr class="row-odd"><td><p>Ranking Functions</p></td>
<td class="text-align:center"><p><ul><li>rank</li><li>dense_rank</li></ul><ul><li>percent_rank</li><li>row_number</li> <li>ntile</li></ul></p></td>
</tr>
<tr class="row-even"><td><p>Analytic Functions</p></td>
<td class="text-align:center"><p><ul><li>cume_dist</li><li>first</li><li>last</li><li>lead</li> <li>lag</li></ul></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="aggregate-functions">
<h2><span class="section-number">7.3. </span>Aggregate Functions<a class="headerlink" href="#aggregate-functions" title="Permalink to this headline">¶</a></h2>
<p>Let us see how to perform aggregations within each group while projecting the raw data that is used to perform the aggregation.</p>
<ul class="simple">
<li><p>We have functions such as <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">avg</span></code>, <code class="docutils literal notranslate"><span class="pre">min</span></code>, <code class="docutils literal notranslate"><span class="pre">max</span></code> etc which can be used to aggregate the data.</p></li>
<li><p>We need to create <code class="docutils literal notranslate"><span class="pre">WindowSpec</span></code> object using <code class="docutils literal notranslate"><span class="pre">partitionBy</span></code> to get aggregations within each group.</p></li>
<li><p>Typically we don’t need to sort the data to perform aggregations, however if we want to perform cumulative aggregations using rowsBetween, then we have to sort the data using cumulative criteria.</p></li>
<li><p>Let us try to get total departure delay, minimum departure delay, maximum departure delay and average departure delay for each day for each airport. We will ignore all those flights which are departured early or ontime.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines_path</span> <span class="o">=</span> <span class="s">&quot;/public/airlines_all/airlines-part/flightmonth=200801&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span>
  <span class="n">read</span><span class="o">.</span>
  <span class="n">parquet</span><span class="o">(</span><span class="n">airlines_path</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">lit</span><span class="o">,</span> <span class="n">lpad</span><span class="o">,</span> <span class="n">concat</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">min</span><span class="o">,</span> <span class="n">max</span><span class="o">,</span> <span class="n">sum</span><span class="o">,</span> <span class="n">avg</span><span class="o">,</span> <span class="n">round</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span><span class="n">printSchema</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;IsDepDelayed = &#39;YES&#39; and Cancelled = 0&quot;</span><span class="o">).</span>
    <span class="n">select</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                 <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span>
           <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;IsDepDelayed&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">)</span>
          <span class="o">).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelayMin&quot;</span><span class="o">,</span> <span class="n">min</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelayMax&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelaySum&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelayAvg&quot;</span><span class="o">,</span> <span class="n">round</span><span class="o">(</span><span class="n">avg</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">),</span> <span class="mi">2</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="s">&quot;DepDelay&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-rowsbetween-and-rangebetween">
<h2><span class="section-number">7.4. </span>Using rowsBetween and rangeBetween<a class="headerlink" href="#using-rowsbetween-and-rangebetween" title="Permalink to this headline">¶</a></h2>
<p>We can get cumulative aggregations using <code class="docutils literal notranslate"><span class="pre">rowsBetween</span></code> or <code class="docutils literal notranslate"><span class="pre">rangeBetween</span></code>.</p>
<ul class="simple">
<li><p>We can use <code class="docutils literal notranslate"><span class="pre">rowsBetween</span></code> to include particular set of rows to perform aggregations.</p></li>
<li><p>We can use <code class="docutils literal notranslate"><span class="pre">rangeBetween</span></code> to include particular range of values on a given column.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">).</span>
    <span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;IsDepDelayed = &#39;YES&#39; and Cancelled = 0&quot;</span><span class="o">).</span>
    <span class="n">select</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                 <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span>
           <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;IsDepDelayed&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">)</span>
          <span class="o">).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelaySum&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="s">&quot;CRSDepTime&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">).</span>
    <span class="n">rowsBetween</span><span class="o">(-</span><span class="mi">3</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;IsDepDelayed = &#39;YES&#39; and Cancelled = 0&quot;</span><span class="o">).</span>
    <span class="n">select</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                 <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span>
           <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;IsDepDelayed&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">)</span>
          <span class="o">).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;DepDelaySum&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="s">&quot;CRSDepTime&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ranking-functions">
<h2><span class="section-number">7.5. </span>Ranking Functions<a class="headerlink" href="#ranking-functions" title="Permalink to this headline">¶</a></h2>
<p>We can use ranking functions to assign ranks to a particular record within a partition.</p>
<ul class="simple">
<li><p>Sparse Rank - rank</p></li>
<li><p>Dense Rank - dense_rank</p></li>
<li><p>Assigning Row Numbers - row_number</p></li>
<li><p>Percentage Rank - percent_rank</p></li>
</ul>
<div class="section" id="tasks">
<h3><span class="section-number">7.5.1. </span>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h3>
<p>Let us perform few tasks related to ranking.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines_path</span> <span class="o">=</span> <span class="s">&quot;/public/airlines_all/airlines-part/flightmonth=200801&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span>
    <span class="n">read</span><span class="o">.</span>
    <span class="n">parquet</span><span class="o">(</span><span class="n">airlines_path</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">lit</span><span class="o">,</span> <span class="n">lpad</span><span class="o">,</span> <span class="n">concat</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">rank</span><span class="o">,</span> <span class="n">dense_rank</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">percent_rank</span><span class="o">,</span> <span class="n">row_number</span><span class="o">,</span> <span class="n">round</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">desc</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;IsDepDelayed = &#39;YES&#39; and Cancelled = 0&quot;</span><span class="o">).</span>
    <span class="n">select</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                 <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span>
           <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;IsDepDelayed&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">)</span>
          <span class="o">).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;srank&quot;</span><span class="o">,</span> <span class="n">rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;drank&quot;</span><span class="o">,</span> <span class="n">dense_rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;prank&quot;</span><span class="o">,</span> <span class="n">round</span><span class="o">(</span><span class="n">percent_rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">),</span> <span class="mi">2</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rn&quot;</span><span class="o">,</span> <span class="n">row_number</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="analytic-functions">
<h2><span class="section-number">7.6. </span>Analytic Functions<a class="headerlink" href="#analytic-functions" title="Permalink to this headline">¶</a></h2>
<p>We can use Analytic Functions to compare current record with previous record or next record.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lead</span></code> and <code class="docutils literal notranslate"><span class="pre">lag</span></code> are the main functions.</p></li>
<li><p>We can also compare each of the day of one week with corresponding day of another week.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lead</span></code> and <code class="docutils literal notranslate"><span class="pre">lag</span></code> serve the same purpose. Depending up on the requirement and sorting of the data we can use either of them.</p></li>
<li><p>Here the examples are demonstrated using <code class="docutils literal notranslate"><span class="pre">lead</span></code>. Same can be achieved using <code class="docutils literal notranslate"><span class="pre">lag</span></code> however while defining the spec we have sort the data with in window in descending order to get similar results.</p></li>
<li><p>Also we can use <code class="docutils literal notranslate"><span class="pre">first</span></code> and <code class="docutils literal notranslate"><span class="pre">last</span></code> functions to get first or last value with in each group or partition based up on sorting criteria. They are typically used to get the details about other fields (for example, we can get employee name or id who is making highest or lowest salary with in a department).</p></li>
</ul>
<div class="section" id="using-lead">
<h3><span class="section-number">7.6.1. </span>Using LEAD<a class="headerlink" href="#using-lead" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines_path</span> <span class="o">=</span> <span class="s">&quot;/public/airlines_all/airlines-part/flightmonth=200801&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span>
  <span class="n">read</span><span class="o">.</span>
  <span class="n">parquet</span><span class="o">(</span><span class="n">airlines_path</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">lit</span><span class="o">,</span> <span class="n">lpad</span><span class="o">,</span> <span class="n">concat</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.lead</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;IsDepDelayed = &#39;YES&#39; and Cancelled = 0&quot;</span><span class="o">).</span>
    <span class="n">select</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                  <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                 <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span>
           <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;IsDepDelayed&quot;</span><span class="o">,</span>
           <span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">)</span>
          <span class="o">).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadUniqueCarrier&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;UniqueCarrier&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadFlightNum&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightNum&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadCRSDepTime&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;CRSDepTime&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadDepDelay&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DepDelay&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="s">&quot;CRSDepTime&quot;</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-lead-with-7">
<h3><span class="section-number">7.6.2. </span>Using LEAD with 7<a class="headerlink" href="#using-lead-with-7" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines_path</span> <span class="o">=</span> <span class="s">&quot;/public/airlines_all/airlines-part/flightmonth=200801&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">airlines</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span>
    <span class="n">read</span><span class="o">.</span>
    <span class="n">parquet</span><span class="o">(</span><span class="n">airlines_path</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">lit</span><span class="o">,</span> <span class="n">lpad</span><span class="o">,</span> <span class="n">concat</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">sum</span><span class="o">,</span> <span class="n">lead</span><span class="o">,</span> <span class="n">substring</span><span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">spec</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span>
    <span class="n">partitionBy</span><span class="o">(</span><span class="n">substring</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">6</span><span class="o">),</span> <span class="n">$</span><span class="s">&quot;Origin&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;&quot;&quot;IsDepDelayed = &#39;YES&#39; </span>
<span class="s">              AND Cancelled = 0</span>
<span class="s">              AND concat(Year, </span>
<span class="s">                         lpad(Month, 2, &#39;0&#39;),</span>
<span class="s">                         lpad(DayOfMonth, 2, &#39;0&#39;)</span>
<span class="s">                        ) BETWEEN 20080101 AND 20080114</span>
<span class="s">              AND Origin IN (&#39;ATL&#39;, &#39;DFW&#39;, &#39;JFK&#39;, &#39;LAX&#39;, &#39;SFO&#39;, &#39;ORD&#39;)</span>
<span class="s">           &quot;&quot;&quot;</span>
          <span class="o">).</span>
    <span class="n">groupBy</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                  <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span> 
            <span class="n">$</span><span class="s">&quot;Origin&quot;</span>
           <span class="o">).</span>
    <span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadFlightDate&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadOrigin&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadTotalDepDelay&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;Origin = &#39;ORD&#39;&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;&quot;&quot;IsDepDelayed = &#39;YES&#39; </span>
<span class="s">              AND Cancelled = 0</span>
<span class="s">              AND concat(Year, </span>
<span class="s">                         lpad(Month, 2, &#39;0&#39;),</span>
<span class="s">                         lpad(DayOfMonth, 2, &#39;0&#39;)</span>
<span class="s">                        ) BETWEEN 20080101 AND 20080114</span>
<span class="s">              AND Origin IN (&#39;ATL&#39;, &#39;DFW&#39;, &#39;JFK&#39;, &#39;LAX&#39;, &#39;SFO&#39;, &#39;ORD&#39;)</span>
<span class="s">           &quot;&quot;&quot;</span>
          <span class="o">).</span>
    <span class="n">groupBy</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                  <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span> 
            <span class="n">$</span><span class="s">&quot;Origin&quot;</span>
           <span class="o">).</span>
    <span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadFlightDate&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadOrigin&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadTotalDepDelay&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;Origin = &#39;ORD&#39; AND FlightDate BETWEEN 20080101 AND 20080107&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">airlines</span><span class="o">.</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;&quot;&quot;IsDepDelayed = &#39;YES&#39; </span>
<span class="s">              AND Cancelled = 0</span>
<span class="s">              AND concat(Year, </span>
<span class="s">                         lpad(Month, 2, &#39;0&#39;),</span>
<span class="s">                         lpad(DayOfMonth, 2, &#39;0&#39;)</span>
<span class="s">                        ) BETWEEN 20080101 AND 20080114</span>
<span class="s">              AND Origin IN (&#39;ATL&#39;, &#39;DFW&#39;, &#39;JFK&#39;, &#39;LAX&#39;, &#39;SFO&#39;, &#39;ORD&#39;)</span>
<span class="s">           &quot;&quot;&quot;</span>
          <span class="o">).</span>
    <span class="n">groupBy</span><span class="o">(</span><span class="n">concat</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Year&quot;</span><span class="o">,</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;Month&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">),</span> 
                   <span class="n">lpad</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;DayOfMonth&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="s">&quot;0&quot;</span><span class="o">)</span>
                  <span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">),</span> 
            <span class="n">$</span><span class="s">&quot;Origin&quot;</span>
           <span class="o">).</span>
    <span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DepDelay&quot;</span><span class="o">).</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;int&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadFlightDate&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadOrigin&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;Origin&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;LeadTotalDepDelay&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">spec</span><span class="o">)).</span>
    <span class="n">filter</span><span class="o">(</span><span class="s">&quot;FlightDate BETWEEN 20080101 AND 20080107&quot;</span><span class="o">).</span>
    <span class="n">orderBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;FlightDate&quot;</span><span class="o">,</span> <span class="n">$</span><span class="s">&quot;TotalDepDelay&quot;</span><span class="o">.</span><span class="n">desc</span><span class="o">).</span>
    <span class="n">show</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "apache_toree_scala"
        },
        kernelOptions: {
            kernelName: "apache_toree_scala",
            path: "./spark-scala"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'apache_toree_scala'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="06_joining_data_sets.html" title="previous page"><span class="section-number">6. </span>Joining Data Sets</a>
    <a class='right-next' id="next-link" href="08_spark_metastore.html" title="next page"><span class="section-number">8. </span>Spark Metastore</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>